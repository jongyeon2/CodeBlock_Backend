name: Backend CI/CD

on:
  workflow_dispatch:

concurrency:
  group: backend-${{ github.ref }}  # ë¸Œëœì¹˜ë³„ë¡œ ë³„ë„ ê·¸ë£¹
  cancel-in-progress: true

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/elearning-backend
  CONTAINER_NAME: elearning-backend

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Backend EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_EC2_HOST }}
          username: ${{ secrets.BACKEND_EC2_USERNAME }}
          key: ${{ secrets.BACKEND_EC2_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            cd /opt/elearning

            # .env íŒŒì¼ ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
            echo "${{ secrets.BACKEND_ENV_FILE }}" > .env

            # ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Pulling latest backend image..."
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down || true

            # ì „ì²´ ìŠ¤íƒ ì‹œì‘ (MySQL + Redis + Backend)
            echo "ğŸš€ Starting backend stack..."
            docker compose up -d

            # Spring Boot ì´ˆê¸°í™” ëŒ€ê¸° (ì¶©ë¶„í•œ ì‹œê°„ í™•ë³´)
            echo "â³ Waiting for backend to start (90 seconds)..."
            sleep 90

            # ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ Backend logs (last 30 lines):"
            docker logs ${{ env.CONTAINER_NAME }} --tail=30

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo ""
            echo "ğŸ” Container status:"
            docker compose ps backend

            # Running ìƒíƒœ í™•ì¸
            if docker compose ps backend | grep -q "Up"; then
              echo ""
              echo "âœ… Backend deployment successful!"
            else
              echo ""
              echo "âŒ Backend container is not running!"
              echo "=== Full Container Status ==="
              docker compose ps
              echo ""
              echo "=== Backend Logs (last 100 lines) ==="
              docker logs ${{ env.CONTAINER_NAME }} --tail=100
              echo ""
              echo "=== MySQL Logs ==="
              docker logs elearning-mysql --tail=50 || true
              echo ""
              echo "=== Redis Logs ==="
              docker logs elearning-redis --tail=50 || true
              exit 1
            fi

            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true

            echo "ğŸ‰ Backend deployment completed successfully!"

      - name: Print backend logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_EC2_HOST }}
          username: ${{ secrets.BACKEND_EC2_USERNAME }}
          key: ${{ secrets.BACKEND_EC2_SSH_KEY }}
          script: |
            cd /opt/elearning
            echo "=== Container Status ==="
            docker compose ps
            echo ""
            echo "=== Backend Logs (last 200 lines) ==="
            docker logs ${{ env.CONTAINER_NAME }} --tail=200 || true
            echo ""
            echo "=== MySQL Logs (last 50 lines) ==="
            docker logs elearning-mysql --tail=50 || true
            echo ""
            echo "=== Redis Logs (last 50 lines) ==="
            docker logs elearning-redis --tail=50 || true

      - name: Cleanup always
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BACKEND_EC2_HOST }}
          username: ${{ secrets.BACKEND_EC2_USERNAME }}
          key: ${{ secrets.BACKEND_EC2_SSH_KEY }}
          script: |
            cd /opt/elearning
            # í•„ìš” ì‹œ í”„ë¦¬ì§• ë°©ì§€ìš© ì •ë¦¬
            docker system prune -f --filter "until=24h" || true